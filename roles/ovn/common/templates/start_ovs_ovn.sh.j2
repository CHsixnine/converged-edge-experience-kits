# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020 Intel Corporation

#!/bin/bash

export PATH=$PATH:/usr/local/share/ovn/scripts:/usr/share/openvswitch/scripts

# Start vswitchd
ovs-ctl restart --no-ovs-vswitchd --system-id=random

# Start ovsdb
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem="{{ ovs_dpdk_socket_mem }}"
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
ovs-vsctl --no-wait set Open_vSwitch . other_config:pmd-cpu-mask="{{ ovs_dpdk_pmd_cpu_mask }}"
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-lcore-mask="{{ ovs_dpdk_lcore_mask }}"
ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-hugepage-dir="{{ huge_dir }}"

ovs-ctl restart --no-ovsdb-server  --system-id=random
ovs-ctl --protocol=udp --dport=6081 enable-protocol


# Start ovn-controller
ovn-ctl restart_controller
ovn-ctl restart_controller_vtep

# Configure ovn-sb
ovs-vsctl set open . external-ids:ovn-encap-ip={{ host_ip }}
ovs-vsctl set open . external-ids:ovn-remote=tcp:{{ controller_ip }}:6642
ovs-vsctl set open . external-ids:ovn-remote-probe-interval=10000
ovs-vsctl set open . external-ids:ovn-encap-type=geneve


tail -f /var/log/openvswitch/ovs-vswitchd.log

