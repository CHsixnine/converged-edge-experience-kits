# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2019 Intel Corporation

---

- name: include common vars
  include_vars: ../common/defaults/main.yml

- name: build OVS-DPDK images
  block:
    - name: apply patch to start_ovs_ovn.sh for controller
      patch:
        src: "start_ovs_ovn.patch"
        dest: "{{ dpdk_install_dir }}/start_ovs_ovn.sh"
        basedir: "{{ dpdk_install_dir }}"

    - name: build OVS-DPDK image (this may take some time...)
      docker_image:
        name: ovs-ovn
        source: build
        state: present
        force_source: yes
        build:
          path: "{{ dpdk_install_dir }}"
          dockerfile: Dockerfile
          pull: yes
          use_config_proxy: yes

    - name: Clean docker image files from dpdk directory
      file:
        state: absent
        path: "{{ dpdk_install_dir }}/{{ item }}"
      with_items: "{{ dockerimage_files_to_rm }}"
  when: ovs_dpdk and not offline_mode

- name: open ovn firewall rules
  ignore_errors: yes
  firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  with_items:
  - 6641/tcp
  - 6642/tcp
  - 6081/udp

- name: run ovn-ovs container
  docker_container:
    name: ovs-ovn
    image: ovs-ovn
    privileged: yes
    network_mode: host
    published_ports:
      - 6641:6641
      - 6642:6642
      - 6081:6081/udp
    volumes:
      - "{{ huge_dir }}:{{ huge_dir}}:rw"
      - "{{ ovs_dir }}:{{ ovs_dir }}:rw"
      - /dev:/dev:rw
      - /lib/modules:/lib/modules:rw
    memory: "{{ ovs_dpdk_resource_limits }}"

- name: wait for OVN DB socket
  wait_for:
    path: /var/run/openvswitch/ovnnb_db.sock
    timeout: 600
  changed_when: false

