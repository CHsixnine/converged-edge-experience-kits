# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020 Intel Corporation

---

apiVersion: apps/v1
kind: DaemonSet
metadata:
  namespace: telemetry
  name: node-exporter
  labels:
    app: node-exporter
spec:
  selector:
    matchLabels:
      name: node-exporter
  template:
    metadata:
      name:  node-exporter
      labels:
        name: node-exporter
    spec:
      hostNetwork: true
      hostPID: true
      tolerations:
      - effect: NoSchedule
        key: cmk
        operator: Exists
      containers:
      - name:  node-exporter
        image: prom/node-exporter:v1.0.0-rc.0
        command: ["/bin/node_exporter"]
        args: ["--web.config=/opt/config/web-config.yml", "--collector.textfile.directory=/opt/vpumetrics"]
        ports:
          - containerPort: 9100
            hostPort: 9100
        securityContext:
          privileged: true
        volumeMounts:
          - name: ca
            mountPath: /opt/CA
          - name: cert-vol
            mountPath: /opt/certs/
          - name: config-vol
            mountPath: /opt/config/
          - name: vpumetrics
            mountPath: /opt/vpumetrics
      initContainers:
        - name: openssl
          image: emberstack/openssl:latest
          command: ["/bin/sh","-c"]
          args: ["rm -Rf /root/certs/node_exporter && \
                mkdir /root/certs/node_exporter && \
                /root/certgen/entrypoint_tls.sh node_exporter /root/certs/node_exporter /root/CA && \
                chmod 644 /root/certs/node_exporter/cert.pem /root/certs/node_exporter/key.pem"]
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: "0.1"
            limits:
              cpu: "0.1"
              memory: "128Mi"
          volumeMounts:
          - name: ca
            mountPath: /root/CA
          - name: cert-vol
            mountPath: /root/certs
          - name: certgen
            mountPath: /root/certgen
      volumes:
      - name: cert-vol
        hostPath:
          path: /etc/openness/certs/telemetry
          type: DirectoryOrCreate
      - name: config-vol
        configMap:
          defaultMode: 420
          name: node-exporter-cm
      - name: ca
        secret:
          secretName: root-ca
      - name: certgen
        secret:
          secretName: certgen
          defaultMode: 0744
      - name: vpumetrics 
        hostPath:
          path: /tmp/node-exporter
          type: DirectoryOrCreate
