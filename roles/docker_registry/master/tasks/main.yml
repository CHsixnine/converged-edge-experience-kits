# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020 Intel Corporation

---

- name: copy docker registry file
  copy:
    src: "{{ item }}"
    dest: "{{ _registry_location }}"
    mode: 0744
  with_items:
    - genCerts.sh

- name: create directory for copying certificate
  file:
    path: /etc/docker/certs.d/{{ _registry_ip_address }}:{{ _registry_port }}
    state: directory
  changed_when: true

- name: create openness namespace if needed
  block:
  - name: check if openness namespace exists
    command: kubectl get ns openness
    ignore_errors: yes
    register: get_ns_openness
  - name: create openness namespace
    command: kubectl create namespace openness
    when: get_ns_openness.rc == 1

- name: docker-registry create self signed certificate
  command : "{{ item }}"
  with_items:
    - rm -rf *.pem extfile.cnf root-ca-cert.srl server-request.csr ca.crt
    - ./genCerts.sh -t IP -h  {{ _registry_ip_address }}
    - mv  root-ca-cert.pem ca.crt
    - cp -rf  ca.crt /etc/docker/certs.d/{{ _registry_ip_address }}:{{ _registry_port }}/
  args:
    chdir: "{{ _registry_location }}"
  changed_when: true

- name: delete docker registry pod if it exists
  command: "{{ item }}"
  with_items:
    - kubectl -n openness delete deployment docker-registry-deployment
    - kubectl get pods -n openness --no-headers=true | awk '/docker-registry/{print $1}'| xargs  kubectl delete -n openness pod --grace-period=0 --force
  ignore_errors: yes
  changed_when: true

- name: template a file to docker_registry.yml
  template:
    src: docker_registry.yml.j2
    dest: "{{ _registry_location }}/docker_registry.yml"
    mode: '0644'

- name: deploy docker-registry pod on master node
  command: "{{ item }}"
  with_items:
    - kubectl apply -f docker_registry.yml
  args:
    chdir: "{{ _registry_location }}"
  changed_when: true

- name: add firewall rules for docker registry
  command: "{{ item }}"
  with_items:
    - firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp --dport 5000 -j ACCEPT
  ignore_errors: yes
  changed_when: true


- name: copy public key from master to local ansible host
  fetch:
    src: "{{ _registry_location }}/ca.crt"
    dest: /etc/docker/certs.d/{{ _registry_ip_address }}:{{ _registry_port }}/ca.crt
    flat: yes
