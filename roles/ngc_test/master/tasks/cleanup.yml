# SPDX-License-Identifier: Apache-2.0
# Copyright Â© 2019 Intel Corporation

---
- name: include docker registry vars
  include_vars: ../../../docker_registry/master/defaults/main.yml

- block:
    - name: uninstall the CNTF Helm Chart
      command: helm uninstall "{{ _helm_release_name.cntf }}"
      ignore_errors: yes

    - name: remove the CNTF Helm Chart
      file:
        path: "{{ ne_helm_charts_default_dir }}/{{ _helm_release_name.cntf }}"
        state: absent
      ignore_errors: yes

    - name: remove CNTF docker image
      command: docker image rm -f "{{ _registry_ip_address }}:{{ _registry_port }}/{{  _image_name.cntf }}:{{ _image_tag.cntf }}"
      ignore_errors: yes

- block:
    - name: uninstall the AF Helm Chart
      command: helm uninstall "{{ _helm_release_name.af }}"
      ignore_errors: yes

    - name: remove the AF Helm Chart
      file:
        path: "{{ ne_helm_charts_default_dir }}/{{ _helm_release_name.af }}"
        state: absent
      ignore_errors: yes

    - name: remove AF docker image
      command: docker image rm -f "{{ _registry_ip_address }}:{{ _registry_port }}/{{  _image_name.af }}:{{ _image_tag.af }}"
      ignore_errors: yes

- block:
    - name: uninstall the NEF Helm Chart
      command: helm uninstall "{{ _helm_release_name.nef }}"
      ignore_errors: yes

    - name: remove the NEF Helm Chart
      file:
        path: "{{ ne_helm_charts_default_dir }}/{{ _helm_release_name.nef }}"
        state: absent
      ignore_errors: yes

    - name: remove NEF docker image
      command: docker image rm -f "{{ _registry_ip_address }}:{{ _registry_port }}/{{  _image_name.af }}:{{ _image_tag.nef }}"
      ignore_errors: yes


- block:
  - name: uninstall the OAM Helm Chart
    command: helm uninstall "{{ _helm_release_name.oam }}"
    ignore_errors: yes

  - name: remove the OAM Helm Chart
    file:
      path: "{{ ne_helm_charts_default_dir }}/{{ _helm_release_name.oam }}"
      state: absent
    ignore_errors: yes

  - name: remove OAM docker image
    command: docker image rm -f "{{ _registry_ip_address }}:{{ _registry_port }}/{{  _image_name.oam }}:{{ _image_name.oam }}"
    ignore_errors: yes

- block:
    - name: Forcefull cleanup any pods in terminating state
      shell: for p in $(kubectl get pods -n ngc | grep Terminating | awk '{print $1}'); do kubectl delete pod $p -n ngc --grace-period=0 --force;done
      ignore_errors: yes


- block:
    - name: output hostname
      command: hostname
      register: hostname_output
    - name: register k8s master node name
      set_fact:
        k8s_master_node_name: "{{ hostname_output.stdout | lower }}"
    - name: remove label on master node
      command: kubectl label nodes {{ k8s_master_node_name }} 5g-openness=false --overwrite

- name: remove firewall rules
  include_tasks: rm_firewall_rules.yml
