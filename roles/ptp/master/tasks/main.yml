# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020 Intel Corporation

---

- name: Configure the server acting as the PTP master for PTP slaves
  block:
  - name: Start port snchronization towards PTP GM or local CLOCK_REALTIME
    command: ./ptp4l -f ./configs/default_slave.cfg -2 -i {{ ptp_port_gm }} -m
    args:
      chdir: "{{ _linuxptp_git_repo.download_dir }}"
    async: "{{ async_time }}"
    poll: 0
    register: ptp4l_to_gm
    when: (ptp_port_gm is defined) and (ptp_port_gm is not none)

  - name: Check previous command status - if not failed
    async_status:
      jid: '{{ ptp4l_to_gm.ansible_job_id }}'
    register: ptp4l_master_gm_job_res
    retries: "{{ number_of_retries }}"
    delay: "{{ retry_delay }}"
    failed_when: ptp4l_master_gm_job_res.stderr is defined and
                 ptp4l_master_gm_job_res.stderr | length > 0
    ignore_errors: true
    when: (ptp_port_gm is defined) and (ptp_port_gm is not none)

  - name: Synchronize local timer clock
    command: ./phc2sys  -s {{ _master_clock }} -w -m -R 8
    args:
      chdir: "{{ _linuxptp_git_repo.download_dir }}"
    register: phc2sys_master
    async: "{{ async_time }}"
    poll: 0

  - name: Check previous command status - if not failed
    async_status:
      jid: '{{ phc2sys_master.ansible_job_id }}'
    register: phc2sys_master_job_res
    retries: "{{ number_of_retries }}"
    delay: "{{ retry_delay }}"
    failed_when: phc2sys_master_job_res.stderr is defined and
                 phc2sys_master_job_res.stderr | length > 0
    ignore_errors: true

  - name: Apply patch to config
    patch:
      src: "../../master/files/{{ _config_patch }}"
      dest: "{{ _linuxptp_git_repo.download_dir }}/configs/default.cfg"
    delegate_to: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

  - name: Start PTP master port towards slave(s)
    command: ./ptp4l -f ./configs/default.cfg -2 -i {{ ptp_port }} â€“m
    args:
      chdir: "{{ _linuxptp_git_repo.download_dir }}"
    async: "{{ async_time }}"
    poll: 0
    register: ptp_to_node
    failed_when: ptp_to_node.stderr is defined and ptp_to_node.stderr | length > 0
    ignore_errors: true

  - name: Check previous command status - if not failed
    async_status:
      jid: '{{ ptp_to_node.ansible_job_id }}'
    register: ptp_to_node_job_res
    retries: "{{ number_of_retries }}"
    delay: "{{ retry_delay }}"
    failed_when: ptp_to_node_job_res.stderr is defined and
                 ptp_to_node_job_res.stderr | length > 0
    ignore_errors: true

  - name: Synchronize local NIC PTP master clock to local NIC PTP slave clock
    command: ./phc2sys -c {{ ptp_port }} -s {{ _master_clock }} -w -m -R 8
    args:
      chdir: "{{ _linuxptp_git_repo.download_dir }}"
    async: "{{ async_time }}"
    poll: 0
    register: phc_master_node

  - name: Check previous command status - if not failed
    async_status:
      jid: '{{ ptp_to_node.ansible_job_id }}'
    register: phc_master_node_job_res
    retries: "{{ number_of_retries }}"
    delay: "{{ retry_delay }}"
    ignore_errors: true
    failed_when: phc_master_nodejob_res.stderr is defined and
                 phc_master_node_job_res.stderr | length > 0

  - name: verify PTP running on this machine
    include_tasks: ../../common/tasks/verify_ptp_status.yml
  when:
    inventory_hostname in groups['ptp_master']

