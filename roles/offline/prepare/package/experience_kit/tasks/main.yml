# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2019-2020 Intel Corporation

---
- name: create tmp folder
  file:
    path: "{{ _offline_path_common }}/tmp"
    state: directory

- name: create temporary directory
  tempfile:
    state: directory
    suffix: experiencekits
  register: tmp_dir
  delegate_to: localhost

- name: copy OEK to tmp directory
  synchronize:
    src: "{{ playbook_dir }}/"
    dest: "{{ tmp_dir.path }}/openness-experience-kits/"
  delegate_to: localhost

- name: remove OEK logs
  file:
    path: "{{ tmp_dir.path }}/openness-experience-kits/logs"
    state: absent

- name: create temporary archive
  archive:
    path:
      - "{{ tmp_dir.path }}/openness-experience-kits"
    dest: "{{ tmp_dir.path }}/openness-experience-kits.tar.gz"
    format: gz
  delegate_to: localhost

- name: copy OpenNESS experience kits to build machine
  copy:
    src: "{{ tmp_dir.path }}/openness-experience-kits.tar.gz"
    dest: "{{ _offline_path_common }}"

- name: remove temporary directory
  file:
    path: "{{ tmp_dir.path }}"
    state: absent
  delegate_to: localhost

- name: unarchive temporary archive
  unarchive:
    src: "{{ _offline_path_common }}/openness-experience-kits.tar.gz"
    dest: "{{ _offline_path_common }}"
    remote_src: yes

- name: remove temporary archive
  file:
    path: "{{ _offline_path_common }}/openness-experience-kits.tar.gz"
    state: absent

- name: set offline mode to true
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/roles/offline/vars/defaults/main.yml"
    regexp: "_offline_mode:.*$"
    line: "_offline_mode: True"

- name: set proxy to false
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_enable:.*$"
    line: "proxy_enable: false"

- name: set remove old proxy to true
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_remove_old:.*$"
    line: "proxy_remove_old: true"

- name: clear yum proxy
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_yum:.*$"
    line: 'proxy_yum: ""'

- name: clear http proxy
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_http:.*$"
    line: 'proxy_http: "http://proxy.example.org:3128"'

- name: clear https proxy
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_https:.*$"
    line: 'proxy_https: "http://proxy.example.org:3129"'

- name: clear ftp proxy
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "proxy_ftp:.*$"
    line: 'proxy_ftp: "http://proxy.example.org:3128"'

- name: clear git token
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "git_repo_token:.*$"
    line: 'git_repo_token: ""'

- name: disable ntp role
  lineinfile:
    path: "{{ _offline_experience_kits_path }}/group_vars/all/10-default.yml"
    regexp: "ntp_enable:.*$"
    line: "ntp_enable: false"

- name: remove .git directory
  file:
    state: absent
    path: "{{ _offline_experience_kits_path }}/.git"

- name: remove .gitignore
  file:
    state: absent
    path: "{{ _offline_experience_kits_path }}/.gitignore"

- name: create openness-experience-kits archive
  archive:
    path:
      - "{{ _offline_experience_kits_path }}"
    dest: "{{ _offline_path_common }}/tmp/openness-experience-kits.tar.gz"
    format: gz
