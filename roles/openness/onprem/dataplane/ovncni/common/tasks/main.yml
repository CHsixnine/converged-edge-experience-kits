# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020 Intel Corporation

---

- name: generate Dockerfile from template
  template:
    src: Dockerfile.j2
    dest: "{{ dpdk_install_dir }}/Dockerfile"

- name: copy configure_ovn_net.sh
  copy:
    src: configure_ovn_net.sh
    dest: "{{ dpdk_install_dir }}/configure_ovn_net.sh"

- name: generate start_ovs_ovn.sh from template
  template:
    src: start_ovs_ovn.sh.j2
    dest: "{{ dpdk_install_dir }}/start_ovs_ovn.sh"
    mode: '0744'

- name: install patch utility
  yum:
    name: patch
    state: present

#TODO: Use variables(Currently defined in configure_ovn_net.sh)
- name: Add firewall rules for OVN masquerade
  command: firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -s 100.0.0.0/16 -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
  changed_when: true

- name: Add firewall rules to accept ovn-local interface
  command: firewall-cmd --permanent --zone=trusted --change-interface=ovn-local
  changed_when: true

- name: Reload firewall rules
  command: firewall-cmd --reload
  changed_when: true
