# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2019-2020 Intel Corporation

---
- debug:
    msg: "Installing the following packages: {{ os_yum_base_packages }}"
- name: install IUS repository
  yum:
    name: https://repo.ius.io/ius-release-el7.rpm
    state: present
- name: install base OS rpm packages
  yum:
    name: "{{ os_yum_base_packages }}"
    state: present
    enablerepo: ius-archive
    skip_broken: yes

- name: install base OpenSSL from sources
  block:
    - name: OpenSSL create temp dir
      tempfile:
        state: directory
        suffix: -OpenSSL
      register: tmp_dir

    - name: OpenSSL download {{ _openssl_url }}
      get_url:
        url: "{{ _openssl_url }}"
        dest: "{{ tmp_dir.path }}"
        checksum: "sha256:{{ _openssl_checksum_sha256 }}"
      register: result
      retries: "{{ number_of_retries  }}"
      until: result is succeeded
      delay: "{{ retry_delay }}"

    - name: OpenSSL extract
      unarchive:
        src: "{{ tmp_dir.path }}/{{ _openssl_package_name }}.tar.gz"
        dest: "{{ tmp_dir.path }}"
        remote_src: yes

    - name: OpenSSL build and install
      shell: >
        ./config &&
        make -j `nproc` > /dev/null &&
        make install > /dev/null
      args:
        chdir: "{{ tmp_dir.path }}/{{ _openssl_package_name }}"

    - name: OpenSSL create ld config
      copy:
        dest: "/etc/ld.so.conf.d/localuser.conf"
        content: "/usr/local/lib64"

    - name: OpenSSL reload ld configs
      command: "ldconfig -v"

    - name: OpenSSL remove temporary directory
      file:
        path: "{{ tmp_dir.path }}"
        state: absent
